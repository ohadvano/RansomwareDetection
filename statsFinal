#!/usr/bin/env bash

statsDirectory=$1
summaryName=$2
singleSummaryName=$3
configFile=$4

summaryFile="$statsDirectory/$summaryName"

totalWrite=0
totalRmdir=0
totalForget=0
maxFTCthreshold=0
maxSMthreshold=0
maxSEthreshold=0
maxFDthreshold=0
maxSKthreshold=0
totalWriteRisk=0
totalRmdirRisk=0
totalForgetRisk=0
totalRisk=0
{ IFS= read -rd '' config <$configFile;} 2>/dev/null
config=`echo "$config" | sed -e 's/^/| /'`
config=`echo "${config//;}"`
config=`echo "$config" | tr "," " \| "`

writeRegex="\| Write                  \| ([0-9^]+)"
rmdirRegex="\| Rmdir                  \| ([0-9^]+)"
forgetRegex="\| Forget                 \| ([0-9^]+)"
resWriteRegex="\| Resolutions - Write"
resRmdirRegex="\| Resolutions - Rmdir"
resForgetRegex="\| Resolutions - Forget"
ftcRegex="\| File type changes      \| ([0-9^]+)"
smeRegex="\| Similarity Measurement \| ([0-9^]+)"
sheRegex="\| Shannon Enthropy       \| ([0-9^]+)"
fidRegex="\| Files Deletion         \| ([0-9^]+)"
sukRegex="\| Suspicious Keywords    \| ([0-9^]+)"
totalRegex="\| Total                  \| ([0-9^]+)"

function Promote_totalWrite
{
    num=$1
    totalWrite=$((totalWrite+num))
}

function Promote_totalRmdir
{
    num=$1
    totalRmdir=$((totalRmdir+num))
}

function Promote_totalForget
{
    num=$1
    totalForget=$((totalForget+num))
}

function Promote_totalRisk
{
    num=$1
    totalRisk=$((totalRisk+num))
}

function Promote_totalWriteRisk
{
    num=$1
    totalWriteRisk=$((totalWriteRisk+num))
    Promote_totalRisk $num
}

function Promote_totalForgetRisk
{
    num=$1
    totalForgetRisk=$((totalForgetRisk+num))
    Promote_totalRisk $num
}

function Promote_totalRmdirRisk
{
    num=$1
    totalRmdirRisk=$((totalRmdirRisk+num))
    Promote_totalRisk $num
}

function SetIfGreater_maxFTCthreshold
{
    newVal=$1
    if [ "$newVal" -gt "$maxFTCthreshold" ]; then
        maxFTCthreshold=$newVal
    fi
}

function SetIfGreater_maxSMthreshold
{
    newVal=$1
    if [ "$newVal" -gt "$maxSMthreshold" ]; then
        maxSMthreshold=$newVal
    fi
}

function SetIfGreater_maxSEthreshold
{
    newVal=$1
    if [ "$newVal" -gt "$maxSEthreshold" ]; then
        maxSEthreshold=$newVal
    fi
}

function SetIfGreater_maxFDthreshold
{
    newVal=$1
    if [ "$newVal" -gt "$maxFDthreshold" ]; then
        maxFDthreshold=$newVal
    fi
}

function SetIfGreater_maxSKthreshold
{
    newVal=$1
    if [ "$newVal" -gt "$maxSKthreshold" ]; then
        maxSKthreshold=$newVal
    fi
}

# 0 = not set | 1 = WRITE | 2 = FORGET | 3 = RMDIR
context=0

filesName="$statsDirectory/*/$singleSummaryName"
summaryFiles=(`ls $filesName`)

for runResultsFile in (`ls $filesName`)
do
    echo "aasd: $runResultsFile"
    while IFS= read -r summaryLine
    do
        if [[ $summaryLine =~ $writeRegex ]]; then
            number=${BASH_REMATCH[1]}
            Promote_totalWrite $number

        elif [[ $summaryLine =~ $rmdirRegex ]]; then
            number=${BASH_REMATCH[1]}
            Promote_totalRmdir $number

        elif [[ $summaryLine =~ $forgetRegex ]]; then
            number=${BASH_REMATCH[1]}
            Promote_totalForget $number

        elif [[ $summaryLine =~ $resWriteRegex ]]; then
            context=1

        elif [[ $summaryLine =~ $resRmdirRegex ]]; then
            context=3

        elif [[ $summaryLine =~ $resForgetRegex ]]; then
            context=2

        elif [[ $summaryLine =~ $ftcRegex ]]; then
            number=${BASH_REMATCH[1]}
            SetIfGreater_maxFTCthreshold $number

        elif [[ $summaryLine =~ $smeRegex ]]; then
            number=${BASH_REMATCH[1]}
            SetIfGreater_maxSMthreshold $number

        elif [[ $summaryLine =~ $sheRegex ]]; then
            number=${BASH_REMATCH[1]}
            SetIfGreater_maxSEthreshold $number

        elif [[ $summaryLine =~ $fidRegex ]]; then
            number=${BASH_REMATCH[1]}
            SetIfGreater_maxFDthreshold $number

        elif [[ $summaryLine =~ $sukRegex ]]; then
            number=${BASH_REMATCH[1]}
            SetIfGreater_maxSKthreshold $number

        elif [[ $summaryLine =~ $totalRegex ]]; then
            number=${BASH_REMATCH[1]}
            if [ "$context" = "1" ]; then
                Promote_totalWriteRisk $number
            elif [ "$context" = "2" ]; then
                Promote_totalForgetRisk $number
            elif [ "$context" = "3" ]; then
                Promote_totalRmdirRisk $number
            fi

        fi
    done < "$runResultsFile"
done

summaryTemplate="|----------------------------------------\n| Demo Summary\n|----------------------------------------\n| Demo Configurations:\n|----------------------------------------\n$config\n|----------------------------------------\n| Action name            | Total count\n|----------------------------------------\n| Write                  | $totalWrite\n| Rmdir                  | $totalRmdir\n| Forget                 | $totalForget\n|----------------------------------------\n| Heuristic name         | Max threshold\n|----------------------------------------\n| File type changes      | $maxFTCthreshold\n| Similarity Measurement | $maxSMthreshold\n| Shannon Enthropy       | $maxSEthreshold\n| Files Deletion         | $maxFDthreshold\n| Suspicious Keywords    | $maxSKthreshold\n|----------------------------------------\n| Resolutions\n|----------------------------------------\n| Action name            | Total Risk\n|----------------------------------------\n| Write                  | $totalWriteRisk\n| Rmdir                  | $totalRmdirRisk\n| Forget                 | $totalForgetRisk\n| Total                  | $totalRisk\n|----------------------------------------\n"
sudo touch $summaryFile
sudo chmod 777 $summaryFile
sudo echo -en "$summaryTemplate" > $summaryFile