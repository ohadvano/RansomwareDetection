#!/bin/bash

# Required parameters
testName=$1
logFile=$2
statsFile=$3

# Results variables
totalWrite=0
totalRmdir=0
totalForget=0
maxFTCthreshold=0
maxSMthreshold=0
maxSEthreshold=0
maxFDthreshold=0
maxSKthreshold=0
write_at_risk=0
write_aot_risk=0
write_it_risk=0
write_total_risk=0
forget_at_risk=0
forget_aot_risk=0
forget_it_risk=0
forget_total_risk=0
rmdir_at_risk=0
rmdir_aot_risk=0
rmdir_it_risk=0
rmdir_total_risk=0

writeHeaderRegex="\[.*\]\[GATEWAY - WRITE ACTION CAPTURED\]"
forgetHeaderRegex="\[.*\]\[GATEWAY - FORGET ACTION CAPTURED\]"
rmdirHeaderRegex="\[.*\]\[GATEWAY - RMDIR ACTION CAPTURED\]"
fileTypeChangesRegex="\[.*\]\[File Type Changes\]\[New threshold: ([0-9^]+)\]"
similarityRegex="\[.*\]\[Similarity Measurement\]\[New threshold: ([0-9^]+)\]"
shannonRegex="\[.*\]\[Shannon Enthropy\]\[New threshold: ([0-9^]+)\]"
fileDeletionRegex="\[.*\]\[Files Deletion\]\[New threshold: ([0-9^]+)\]"
suspiciousRegex="\[.*\]\[Suspicious Keywords\]\[New threshold: ([0-9^]+)\]"
accumulatedRegex="\[.*\]\[Checking action with: AccumulatedThreshold\]\[Condition result: (Safe|Risk)\]"
anyOverRegex="\[.*\]\[Checking action with: AnyOverThreshold\]\[Condition result: (Safe|Risk)\]"
individualRegex="\[.*\]\[Checking action with: IndividualThresholds\]\[Condition result: (Safe|Risk)\]"
resolutionRegex="\[.*\]\[Action resolution: (Safe|Risk)\]"

function Promote
{
    var=$1
    var=$((var+1))
}

# 0 = not set | 1 = WRITE | 2 = FORGET | 3 = RMDIR
context=0

# Results calculation
while IFS= read -r logLine
do
    # WRITE header
    if [[ $logLine =~ $writeHeaderRegex ]]; then
        context=1
        echo $totalWrite
        Promote $totalWrite
        echo $totalWrite
    # FORGET header
    elif [[ $logLine =~ $forgetHeaderRegex ]]; then
        context=2
        Promote $totalRmdir
    # RMDIR
    elif [[ $logLine =~ $rmdirHeaderRegex ]]; then
        context=3
        Promote $totalForget
    # File type changes threshold line
    elif [[ $logLine =~ $fileTypeChangesRegex ]]; then
        newTh=${BASH_REMATCH[1]}
        echo "ftc: $newTh"
    # Similarity threshold line
    elif [[ $logLine =~ $similarityRegex ]]; then
        newTh=${BASH_REMATCH[1]}
        echo "simi: $newTh"
    # Shannon threshold line
    elif [[ $logLine =~ $shannonRegex ]]; then
        newTh=${BASH_REMATCH[1]}
        echo "sha: $newTh"
    # File deletion threshold line
    elif [[ $logLine =~ $fileDeletionRegex ]]; then
        newTh=${BASH_REMATCH[1]}
        echo "fd: $newTh"
    # Suspicious keywords threshold line
    elif [[ $logLine =~ $suspiciousRegex ]]; then
        newTh=${BASH_REMATCH[1]}
        echo "sk: $newTh"
    # AccumulatedThreshold line
    elif [[ $logLine =~ $accumulatedRegex ]]; then
        riskStatus=${BASH_REMATCH[1]}
        echo "accu $riskStatus"
    # AnyOverThreshold line
    elif [[ $logLine =~ $anyOverRegex ]]; then
        riskStatus=${BASH_REMATCH[1]}
        echo "anyover $riskStatus"
    # IndividualThresholds line
    elif [[ $logLine =~ $individualRegex ]]; then
        riskStatus=${BASH_REMATCH[1]}
        echo "ind $riskStatus"
    # Action resolution line
    elif [[ $logLine =~ $resolutionRegex ]]; then
        riskStatus=${BASH_REMATCH[1]}
        echo "resolution $riskStatus"
    fi
done < "$logFile"

# Results template
resultTemplate="Run statistics for test: $testName\nTotal WRITE actions captured: $totalWrite\nTotal RMDIR actions captured: $totalRmdir\nTotal FORGET actions captured: $totalForget\n\nHeuristics:\nMax 'File Type Changes' threshold: $maxFTCthreshold\nMax 'Similarity Measurement' threshold: $maxSMthreshold\nMax 'Shannon Enthropy' threshold: $maxSEthreshold\nMax 'Files Deletion' threshold: $maxFDthreshold\nMax 'Suspicious Keywords' threshold: $maxSKthreshold\n\nResulutions:\nWrite:\nTotal 'AccumulatedThreshold' checks resolved as a risk: $write_at_risk\nTotal 'AnyOverThreshold' checks resolved as a risk: $write_aot_risk\nTotal 'IndividualThresholds' checks resolved as a risk: $write_it_risk\nTotal actions resolved as a risk: $write_total_risk\nForget:\nTotal 'AccumulatedThreshold' checks resolved as a risk: $forget_at_risk\nTotal 'AnyOverThreshold' checks resolved as a risk: $forget_aot_risk\nTotal 'IndividualThresholds' checks resolved as a risk: $forget_it_risk\nTotal actions resolved as a risk: $forget_total_risk\nRmdir:\nTotal 'AccumulatedThreshold' checks resolved as a risk: $rmdir_at_risk\nTotal 'AnyOverThreshold' checks resolved as a risk: $rmdir_aot_risk\nTotal 'IndividualThresholds' checks resolved as a risk: $rmdir_it_risk\nTotal actions resolved as a risk: $rmdir_total_risk\n"
echo -en $resultTemplate > $statsFile
