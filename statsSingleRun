#!/bin/bash

# Required parameters
testName=$1
logFile=$2
statsFile=$3

# Results variables
totalWrite=0
totalRmdir=0
totalForget=0
maxFTCthreshold=0
maxSMthreshold=0
maxSEthreshold=0
maxFDthreshold=0
maxSKthreshold=0
write_at_risk=0
write_aot_risk=0
write_it_risk=0
write_total_risk=0
forget_at_risk=0
forget_aot_risk=0
forget_it_risk=0
forget_total_risk=0
rmdir_at_risk=0
rmdir_aot_risk=0
rmdir_it_risk=0
rmdir_total_risk=0

fileTypeChangesRegex="a"
similarityRegex="b"
shannonRegex="c"
fileDeletionRegex="d"
suspiciousRegex="e"
accumulatedRegex="f"
anyOverRegex="g"
individualRegex="h"
resolutionRegex="i"

# Results calculation
while IFS= read -r logLine
do
    # File type changes threshold line
    if [[ $logLine =~ $fileTypeChangesRegex ]]; then
        echo "1"
    # Similarity threshold line
    elif [[ $logLine =~ $similarityRegex ]]; then
        echo "2"
    # Shannon threshold line
    elif [[ $logLine =~ $shannonRegex ]]; then
        echo "3"
    # File deletion threshold line
    elif [[ $logLine =~ $fileDeletionRegex ]]; then
        echo "4"
    # Suspicious keywords threshold line
    elif [[ $logLine =~ $suspiciousRegex ]]; then
        echo "5"
    # AccumulatedThreshold line
    elif [[ $logLine =~ $accumulatedRegex ]]; then
        echo "6"
    # AnyOverThreshold line
    elif [[ $logLine =~ $anyOverRegex ]]; then
        echo "7"
    # IndividualThresholds line
    elif [[ $logLine =~ $individualRegex ]]; then
        echo "8"
    # Action resolution line
    elif [[ $logLine =~ $resolutionRegex ]]; then
        echo "9"
    else
        echo "xxx"
    fi
fidone < "$logFile"

# Results template
resultTemplate="Run statistics for test: $testName\nTotal WRITE actions captured: $totalWrite\nTotal RMDIR actions captured: $totalRmdir\nTotal FORGET actions captured: $totalForget\n\nHeuristics:\nMax 'File Type Changes' threshold: $maxFTCthreshold\nMax 'Similarity Measurement' threshold: $maxSMthreshold\nMax 'Shannon Enthropy' threshold: $maxSEthreshold\nMax 'Files Deletion' threshold: $maxFDthreshold\nMax 'Suspicious Keywords' threshold: $maxSKthreshold\n\nResulutions:\nWrite:\nTotal 'AccumulatedThreshold' checks resolved as a risk: $write_at_risk\nTotal 'AnyOverThreshold' checks resolved as a risk: $write_aot_risk\nTotal 'IndividualThresholds' checks resolved as a risk: $write_it_risk\nTotal actions resolved as a risk: $write_total_risk\nForget:\nTotal 'AccumulatedThreshold' checks resolved as a risk: $forget_at_risk\nTotal 'AnyOverThreshold' checks resolved as a risk: $forget_aot_risk\nTotal 'IndividualThresholds' checks resolved as a risk: $forget_it_risk\nTotal actions resolved as a risk: $forget_total_risk\nRmdir:\nTotal 'AccumulatedThreshold' checks resolved as a risk: $rmdir_at_risk\nTotal 'AnyOverThreshold' checks resolved as a risk: $rmdir_aot_risk\nTotal 'IndividualThresholds' checks resolved as a risk: $rmdir_it_risk\nTotal actions resolved as a risk: $rmdir_total_risk\n"
echo -en $resultTemplate > $statsFile
