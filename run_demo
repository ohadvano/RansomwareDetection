#!/usr/bin/env bash
# Parameters
testTar="/home/ohadoz/Desktop/RansomwareDetection/TestData/tar/TestData.tar.gz"
testOutput="/home/ohadoz/Desktop/RansomwareDetection/TestData/output/"
testOutputDirectory="/home/ohadoz/Desktop/RansomwareDetection/TestData/output"
buildOutput="/home/ohadoz/Desktop/RansomwareDetection/src"
sandBox="/tmp/sandbox"
testSummaryRootDirectory="/home/ohadoz/Desktop/RansomwareDetection/TestResults"
now="$(date +'%d-%m-%Y_%H-%M-%S')"
currentDate="Run_$now"
testSummaryFolder="$testSummaryRootDirectory/$currentDate"
ransomwaresListFile="/home/ohadoz/Desktop/RansomwareDetection/ransomwares"
# Endparameters

# Print config
printf "\033[1;34mConfig:\033[0m\n"
echo "Build output: $buildOutput"
echo "Test tar: $testTar"
echo "Test output: $testOutput"
echo "Sandbox: $sandBox"
sleep 1
printf "\033[1;32mOk\033[0m\n"

# Pull repo
printf "\033[1;34mUpdating repository\033[0m\n"
git pull
sleep 3
printf "\033[1;32mOk\033[0m\n"

# Build
printf "\033[1;34mBuilding project\033[0m\n"
cd src
make
sleep 1
printf "\033[1;32mOk\033[0m\n"

# Cleanup
printf "\033[1;34mTest data cleanup\033[0m\n"
rm -rf $testOutputDirectory
runOutput='/home/ohadoz/Desktop/RansomwareDetection/src/Run/*'
runOutput=${runOutput// /\\ }
eval rm -f ${runOutput}
sleep 1
printf "\033[1;32mOk\033[0m\n"

# Deploy data
printf "\033[1;34mCreate test data\033[0m\n"
cd ..
mkdir $testOutput
tar -C $testOutput -zxf $testTar
sleep 1
printf "\033[1;32mOk\033[0m\n"

# Get pre run statistics
printf "\033[1;34mCollecting pre run data\033[0m\n"
mkdir -p $testSummaryRootDirectory
mkdir -p $testSummaryFolder
sleep 1
printf "\033[1;32mOk\033[0m\n"

# Stop if running
printf "\033[1;34mStop previous run\033[0m\n"
sudo umount $sandBox
sleep 1
printf "\033[1;32mOk\033[0m\n"

# Start
printf "\033[1;34mStart Ransomware Detection\033[0m\n"
mkdir -p $sandBox
cd $buildOutput
echo "t $testOutput"
echo "r $sandBox"
./RansomwareGateway $testOutput $sandBox &
sleep 1
printf "\033[1;32mOk\033[0m\n"

# Run ransomwares
printf "\033[1;34mRunning ransomwares\033[0m\n"
cd ..
while IFS= read -r ransomwarePath
do
    ransomwareName=${ransomwarePath##*/}
    printf "\033[1;31mRunning ransomware: %s\033[0m\n" $ransomwareName
    wineCommand="wine $ransomwarePath"
    echo $wineCommand
    echo "sdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddklsdasdumoaiudnvaopdamsdoiaosiduaosiudnva daoisdvnaoisdumvaosdj asdjasd nsjdnkqw dqwm,e Skd okeq;lwe, s;dla wa[e asdkllsdkow eoke aslddkl" > "/tmp/sandbox/Videos/AVI/file_example_AVI_1920_2_3MG.avi"
    # chroot $sandBox $wineCommand
    printf "\033[1;33mDone, collecting mid-test results\033[0m\n"
done < "$ransomwaresListFile"
sleep 1
printf "\033[1;32mOk\033[0m\n"

# Stop
printf "\033[1;34mStopping Ransomware Detection\033[0m\n"
sudo umount $sandBox
printf "\033[1;32mOk\033[0m\n"

# Get statistics
printf "\033[1;34mChecking results\033[0m\n"
logOutput='/home/ohadoz/Desktop/RansomwareDetection/src/Run/Log*'
logOutput=${logOutput// /\\ }
eval cp $logOutput "$testSummaryFolder/log.txt"
sleep 1
printf "\033[1;32mOk\033[0m\n"

# Finish
printf "\033[1;34mTest results at: $testSummaryFolder\033[0m\n"